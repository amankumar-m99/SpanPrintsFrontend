<div class="me-1">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Orders</h3>
        <div class="d-flex">
            <div class="">
                <div class="d-flex flex-column align-items-end">
                    <button class="btn btn-outline-primary position-relative" type="button" data-bs-toggle="collapse"
                        data-bs-target="#filterToolbar" aria-expanded="false" aria-controls="filterToolbar">
                        <i class="bi bi-funnel"></i> Filters
                        <span *ngIf="activeFiltersCount > 0"
                            class="badge bg-danger position-absolute top-0 start-100 translate-middle">
                            {{ activeFiltersCount }}
                        </span>
                    </button>
                    <!-- Filter summary below button -->
                    <div *ngIf="activeFiltersSummary" class="small text-muted mt-1">
                        {{ activeFiltersSummary }}
                    </div>
                </div>
            </div>
            <div class="ms-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#quickOrderModal">
                    + Quick Order
                </button>
                <button class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#fullOrderModal">
                    +
                </button>
                <a class="btn btn-primary ms-2" routerLink="../add-order" type="button"> + New Order</a>
            </div>
        </div>
    </div>

    <div class="row d-none">
        <div class="col-md-6 col-lg-4 mb-3" *ngFor="let order of orders; let i = index">
            <app-order-card [order]="order" (edit)="editOrder(order, i)" (delete)="deleteOrder(order)"></app-order-card>
        </div>
    </div>

    <!-- Collapsible Sticky Toolbar -->
    <div id="filterToolbar" class="collapse d-md-block position-sticky top-0 bg-body shadow-sm z-3 mb-2"
        style="z-index: 1020;"> <!-- z-index keeps it above other elements -->

        <div class="filter-toolbar p-2 rounded">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

                <!-- Search -->
                <div class="d-flex align-items-center gap-2">
                    <input type="text" class="form-control" placeholder="Search by name or phone..."
                        style="min-width: 250px;" [(ngModel)]="searchTerm" (input)="applyFilters()" />
                </div>

                <!-- Filter -->
                <div class="d-flex align-items-center gap-2">
                    <label for="statusFilter" class="form-label mb-0">Status:</label>
                    <select id="statusFilter" class="form-select" style="width: auto;" [(ngModel)]="filterStatus"
                        (change)="applyFilters()">
                        <option value="">All</option>
                        <option value="paid">Paid</option>
                        <option value="partially paid">Partially Paid</option>
                        <option value="unpaid">Unpaid</option>
                    </select>
                </div>

                <!-- Sort -->
                <div class="d-flex align-items-center gap-2">
                    <label for="sortBy" class="form-label mb-0">Sort by:</label>
                    <select id="sortBy" class="form-select" style="width: auto;" [(ngModel)]="sortBy"
                        (change)="applyFilters()">
                        <option value="createdAt_desc">Newest First</option>
                        <option value="createdAt_asc">Oldest First</option>
                        <option value="amount_desc">Amount High → Low</option>
                        <option value="amount_asc">Amount Low → High</option>
                    </select>
                </div>

                <!-- Clear -->
                <div>
                    <button class="btn btn-outline-secondary btn-sm" (click)="clearFilters()">
                        Clear All
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div class="container-fluid mt-3">
        <div class="row g-3">
            <div class="col-12 col-sm-6 col-md-4 col-lg-4" *ngFor="let order of orders">
                <app-order-card [order]="order"></app-order-card>
            </div>
        </div>
    </div>
    <!-- Full Order Modal -->
    <div class="modal fade" id="fullOrderModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="newOrderLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form [formGroup]="orderForm" (ngSubmit)="submitOrder()">
                    <div class="modal-header">
                        <h5 class="modal-title" id="newOrderLabel">{{ editIndex !== null ? 'Edit Order' :
                            'Add New Order' }} </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <!-- Customer Name -->
                            <div class="col-md-6">
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-control" formControlName="customerName">
                            </div>
                            <!-- Phone -->
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" formControlName="phone">
                            </div>
                            <!-- Address -->
                            <div class="col-12">
                                <label class="form-label">Address</label>
                                <textarea class="form-control" rows="2" formControlName="address"></textarea>
                            </div>
                            <!-- Job Type -->
                            <div class="col-md-6">
                                <label class="form-label">Job Type</label>
                                <select class="form-select" formControlName="jobType">
                                    <option value="">-- Select Job Type --</option>
                                    <option *ngFor="let type of jobTypes" [value]="type">{{ type }}</option>
                                </select>
                            </div>
                            <!--  -->
                            <div class="d-none col-md-6">
                                <label for="searchDropdown" class="form-label">Select Item</label>
                                <input type="text" class="form-control" id="searchDropdown"
                                    placeholder="Start typing...">
                                <ul class="list-group position-absolute w-100" id="dropdownList"
                                    style="z-index:1000; max-height:150px; overflow-y:auto; display:none;">
                                    <li class="list-group-item">Item 1</li>
                                    <li class="list-group-item">Item 2</li>
                                    <li class="list-group-item">Item 3</li>
                                    <li class="list-group-item">Item 4</li>
                                </ul>
                            </div>
                            <!--  -->
                            <!-- Count -->
                            <div class="col-md-6">
                                <label class="form-label">Count</label>
                                <input type="number" class="form-control" formControlName="count">
                            </div>
                            <!-- Book Number -->
                            <div class="col-md-6">
                                <label class="form-label">Book Number</label>
                                <input type="number" class="form-control" formControlName="bookNumber">
                            </div>
                            <!-- W-Book Number -->
                            <div class="col-md-6">
                                <label class="form-label">W-Book Number</label>
                                <input type="number" class="form-control" formControlName="wBookNumber">
                            </div>
                            <!-- Date of delivery -->
                            <div class="col-md-6">
                                <label class="form-label">Date of delivery</label>
                                <input type="date" class="form-control" formControlName="dateOfDelivery">
                            </div>
                            <!-- Total Amount -->
                            <div class="col-md-6">
                                <label class="form-label">Total Amount</label>
                                <input type="number" class="form-control" formControlName="totalAmount">
                            </div>
                            <!-- Deposit Amount -->
                            <div class="col-md-6">
                                <label class="form-label">Deposit Amount</label>
                                <input type="number" class="form-control" formControlName="depositAmount">
                            </div>
                            <!-- Remaining Amount -->
                            <div class="col-md-6">
                                <label class="form-label">Remaining Amount</label>
                                <input type="number" class="form-control" formControlName="remainingAmount">
                            </div>
                            <!-- Discounted Amount -->
                            <div class="col-md-6">
                                <label class="form-label">Discounted Amount</label>
                                <input type="number" class="form-control" formControlName="discountedAmount">
                            </div>
                            <!-- Payment Status -->
                            <div class="col-md-6">
                                <label class="form-label">Payment Status</label>
                                <select class="form-select" formControlName="paymentStatus">
                                    <option value="">-- Select Status --</option>
                                    <option value="partially paid">Partially Paid</option>
                                    <option value="paid">Paid</option>
                                    <option value="unpaid">Unpaid</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Add Note</label>
                                <textarea class="form-control" rows="2" formControlName="note"
                                    placeholder="Optional note about the order"></textarea>
                            </div>

                            <!-- Description -->
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" rows="3" formControlName="description"
                                    placeholder="Detailed order description"></textarea>
                            </div>

                            <!-- Attachments -->
                            <div class="col-12">
                                <label class="form-label">Attachments</label>
                                <input type="file" class="form-control" (change)="onFileSelected($event)" multiple
                                    accept="image/*,.pdf,.doc,.docx,.zip" />

                                <!-- Show selected files -->
                                <div *ngIf="selectedFiles?.length" class="mt-2 small text-muted">
                                    {{ selectedFiles.length }} file(s) selected.
                                </div>
                                <ul *ngIf="selectedFiles.length" class="list-group mt-2">
                                    <li *ngFor="let file of selectedFiles; let i = index"
                                        class="list-group-item d-flex justify-content-between align-items-center">
                                        <div class="text-truncate" style="max-width: 80%;">
                                            <i class="bi bi-paperclip me-2 text-secondary"></i>
                                            {{ file.name }}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                            (click)="removeFile(i)" title="Remove file">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" [disabled]="orderForm.invalid || isSubmitting">
                            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
                            {{ editIndex !== null ? 'Update Order' : 'Save Order' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Order Modal -->
    <div class="modal fade" id="quickOrderModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="newOrderLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form [formGroup]="orderForm" (ngSubmit)="submitOrder()">
                    <div class="modal-header">
                        <h5 class="modal-title" id="newOrderLabel">{{ editIndex !== null ? 'Edit Order' :
                            'Add New Order' }} </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <!-- Customer Name -->
                            <div class="col-md-6">
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-control" formControlName="customerName">
                            </div>
                            <!-- Phone -->
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" formControlName="phone">
                            </div>
                            <!-- Address -->
                            <div class="col-md-6">
                                <label class="form-label">Address</label>
                                <textarea class="form-control" rows="1" formControlName="address"></textarea>
                            </div>
                            <!-- Date of delivery -->
                            <div class="col-md-6">
                                <label class="form-label">Date of delivery</label>
                                <input type="date" class="form-control" formControlName="dateOfDelivery">
                            </div>
                            <!-- Job Type -->
                            <div class="col-md-6">
                                <label class="form-label">Job Type</label>
                                <select class="form-select" formControlName="jobType">
                                    <option value="">-- Select Job Type --</option>
                                    <option *ngFor="let type of jobTypes" [value]="type">{{ type }}</option>
                                </select>
                            </div>
                            <!--  -->
                            <div class="d-none col-md-6">
                                <label for="searchDropdown" class="form-label">Select Item</label>
                                <input type="text" class="form-control" id="searchDropdown"
                                    placeholder="Start typing...">
                                <ul class="list-group position-absolute w-100" id="dropdownList"
                                    style="z-index:1000; max-height:150px; overflow-y:auto; display:none;">
                                    <li class="list-group-item">Item 1</li>
                                    <li class="list-group-item">Item 2</li>
                                    <li class="list-group-item">Item 3</li>
                                    <li class="list-group-item">Item 4</li>
                                </ul>
                            </div>
                            <!--  -->
                            <!-- Count -->
                            <div class="col-md-6">
                                <label class="form-label">Count</label>
                                <input type="number" class="form-control" formControlName="count">
                            </div>
                            <!-- Total Amount -->
                            <div class="col-md-6">
                                <label class="form-label">Total Amount</label>
                                <input type="number" class="form-control" formControlName="totalAmount">
                            </div>
                            <!-- Deposit Amount -->
                            <div class="col-md-6">
                                <label class="form-label">Deposit Amount</label>
                                <input type="number" class="form-control" formControlName="depositAmount">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Add Note</label>
                                <textarea class="form-control" rows="2" formControlName="note"
                                    placeholder="Optional note about the order"></textarea>
                            </div>
                        </div>
                        <span class="mt-2"><a routerLink="../add-order">Go to full order form</a></span>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" [disabled]="orderForm.invalid || isSubmitting">
                            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
                            {{ editIndex !== null ? 'Update Order' : 'Save Order' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>